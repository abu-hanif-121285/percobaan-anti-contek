<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Ujian Aman</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Mencegah seleksi teks secara global (CSS Only) */
        body {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Memastikan tombol tetap bisa diklik */
        button {
            user-select: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- Ikon SVG Inline ---
        const IconShield = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        );
        const IconAlertTriangle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        );
        const IconClock = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        );
        const IconCheckCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const IconBan = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>
        );
        const IconMaximize = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
        );
        const IconRefreshCw = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const IconFileWarning = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 13v4"/><path d="M12 21h.01"/></svg>
        );
        const IconLock = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        );


        // --- Data Soal ---
        const QUESTIONS = [
            {
                id: 1,
                question: "Apa ibu kota dari Indonesia?",
                options: ["Jakarta", "Surabaya", "Bandung", "Medan"],
                correctAnswer: "Jakarta"
            },
            {
                id: 2,
                question: "Berapa hasil dari 12 x 12?",
                options: ["124", "144", "142", "122"],
                correctAnswer: "144"
            },
            {
                id: 3,
                question: "Planet manakah yang dikenal sebagai Planet Merah?",
                options: ["Venus", "Mars", "Jupiter", "Saturnus"],
                correctAnswer: "Mars"
            },
            {
                id: 4,
                question: "Siapakah penemu bola lampu?",
                options: ["Nikola Tesla", "Thomas Alva Edison", "Alexander Graham Bell", "Isaac Newton"],
                correctAnswer: "Thomas Alva Edison"
            },
            {
                id: 5,
                question: "Unsur kimia dengan simbol 'O' adalah...",
                options: ["Emas", "Perak", "Oksigen", "Osmium"],
                correctAnswer: "Oksigen"
            }
        ];

        const MAX_WARNINGS = 3;
        const EXAM_DURATION = 300; // 5 menit

        // --- Komponen Utama ---
        const App = () => {
            const [status, setStatus] = useState('intro'); // intro, active, locked, finished
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [answers, setAnswers] = useState({});
            const [timeLeft, setTimeLeft] = useState(EXAM_DURATION);
            const [warnings, setWarnings] = useState(0);
            const [violationLog, setViolationLog] = useState([]);
            const [score, setScore] = useState(0);
            
            // State untuk cek fullscreen realtime
            const [isFullscreen, setIsFullscreen] = useState(false);
            
            // Ref untuk tracking status aktif di dalam event listener
            const statusRef = useRef(status);
            useEffect(() => { statusRef.current = status; }, [status]);

            // Timer Logic
            useEffect(() => {
                let timer;
                if (status === 'active' && timeLeft > 0) {
                    timer = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0 && status === 'active') {
                    finishExam();
                }
                return () => clearInterval(timer);
            }, [status, timeLeft]);

            // --- Anti-Cheat Logic ---
            
            const logViolation = useCallback((reason) => {
                if (statusRef.current !== 'active') return; // Gunakan Ref untuk nilai paling update

                setWarnings(prev => {
                    const newWarnings = prev + 1;
                    if (newWarnings >= MAX_WARNINGS) {
                        setStatus('locked');
                        if (document.fullscreenElement) {
                            document.exitFullscreen().catch(() => {});
                        }
                    }
                    return newWarnings;
                });
                
                setViolationLog(prev => [...prev, `${reason} pada ${new Date().toLocaleTimeString()}`]);
            }, []);

            // 1. Deteksi Pindah Tab & Kehilangan Fokus (STRICT MODE)
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (document.hidden && statusRef.current === 'active') {
                        logViolation("Meninggalkan halaman ujian (Tab Switch/Minimize)");
                    }
                };

                const handleBlur = () => {
                    // Cek jika status aktif
                    if (statusRef.current === 'active') {
                        // Trik: Beri jeda sedikit. Jika pengguna Alt+Tab, document.hidden akan menjadi true.
                        // Kita biarkan handleVisibilityChange yang menangkapnya agar tidak double strike.
                        // Tapi jika document.hidden TETAP false setelah blur, berarti user klik browser chrome/aplikasi lain tapi window masih terlihat.
                        setTimeout(() => {
                            if (!document.hidden && statusRef.current === 'active') {
                                logViolation("Kehilangan Fokus (Klik di luar ujian/Browser Bar)");
                            }
                        }, 200);
                    }
                };

                document.addEventListener("visibilitychange", handleVisibilityChange);
                window.addEventListener("blur", handleBlur); // Mendeteksi klik di luar window
                
                return () => {
                    document.removeEventListener("visibilitychange", handleVisibilityChange);
                    window.removeEventListener("blur", handleBlur);
                };
            }, [logViolation]);

            // 2. Deteksi Status Fullscreen (Realtime Enforcer)
            useEffect(() => {
                const checkFullscreen = () => {
                    const isFs = !!document.fullscreenElement || 
                                 !!document.webkitFullscreenElement || 
                                 !!document.mozFullScreenElement || 
                                 !!document.msFullscreenElement;
                    
                    setIsFullscreen(isFs);

                    // Jika keluar fullscreen saat aktif, catat pelanggaran
                    if (!isFs && status === 'active') {
                        logViolation("Keluar dari mode Layar Penuh");
                    }
                };

                // Listeners
                document.addEventListener("fullscreenchange", checkFullscreen);
                document.addEventListener("webkitfullscreenchange", checkFullscreen);
                document.addEventListener("mozfullscreenchange", checkFullscreen);
                document.addEventListener("MSFullscreenChange", checkFullscreen);

                // Check initial state
                checkFullscreen();

                return () => {
                    document.removeEventListener("fullscreenchange", checkFullscreen);
                    document.removeEventListener("webkitfullscreenchange", checkFullscreen);
                    document.removeEventListener("mozfullscreenchange", checkFullscreen);
                    document.removeEventListener("MSFullscreenChange", checkFullscreen);
                };
            }, [status, logViolation]);

            // 3. Prevent Copy, Paste, Context Menu (REMOVED selectstart listener to fix selection bug)
            useEffect(() => {
                const preventAction = (e) => {
                    e.preventDefault();
                };

                if (status === 'active') {
                    document.addEventListener('contextmenu', preventAction);
                    document.addEventListener('copy', preventAction);
                    document.addEventListener('paste', preventAction);
                    document.addEventListener('cut', preventAction);
                    // document.addEventListener('selectstart', preventAction); // <-- DIHAPUS agar tombol bisa diklik
                }

                return () => {
                    document.removeEventListener('contextmenu', preventAction);
                    document.removeEventListener('copy', preventAction);
                    document.removeEventListener('paste', preventAction);
                    document.removeEventListener('cut', preventAction);
                    // document.removeEventListener('selectstart', preventAction);
                };
            }, [status]);

            // --- Navigasi & Aksi ---

            // Fungsi helper untuk request fullscreen cross-browser
            const triggerFullscreen = async () => {
                const elem = document.documentElement;
                const requestFS = elem.requestFullscreen || 
                                  elem.webkitRequestFullscreen || 
                                  elem.mozRequestFullScreen || 
                                  elem.msRequestFullscreen;
                
                if (requestFS) {
                    await requestFS.call(elem);
                } else {
                    throw new Error("Fullscreen not supported");
                }
            };

            const startExam = async () => {
                try {
                    await triggerFullscreen();
                    setStatus('active');
                    setIsFullscreen(true);
                } catch (err) {
                    console.warn("Fullscreen gagal:", err);
                    alert("ERROR: Browser memblokir Fullscreen. Anda WAJIB mengizinkan Fullscreen untuk memulai ujian ini.");
                    // Tidak set status active jika gagal (Strict Mode)
                }
            };

            const resumeExam = async () => {
                try {
                    await triggerFullscreen();
                    // Status tetap active, hanya overlay yang hilang nanti karena isFullscreen jadi true
                } catch (err) {
                    alert("Gagal kembali ke Fullscreen. Silakan coba lagi.");
                }
            };

            // PERBAIKAN: Gunakan ID soal sebagai key untuk menyimpan jawaban
            const handleAnswer = (questionId, option) => {
                setAnswers(prevAnswers => ({ ...prevAnswers, [questionId]: option }));
            };

            const nextQuestion = () => {
                if (currentQuestion < QUESTIONS.length - 1) {
                    setCurrentQuestion(curr => curr + 1);
                }
            };

            const prevQuestion = () => {
                if (currentQuestion > 0) {
                    setCurrentQuestion(curr => curr - 1);
                }
            };

            const finishExam = () => {
                let calculatedScore = 0;
                QUESTIONS.forEach(q => {
                    if (answers[q.id] === q.correctAnswer) {
                        calculatedScore += 20;
                    }
                });
                setScore(calculatedScore);
                setStatus('finished');
                if (document.fullscreenElement) {
                    document.exitFullscreen().catch(() => {});
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };

            // --- Render: Intro ---
            if (status === 'intro') {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4 font-sans text-gray-800">
                        <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-gray-200">
                            <div className="flex justify-center mb-6">
                                <div className="bg-blue-100 p-4 rounded-full">
                                    <IconShield className="w-12 h-12 text-blue-600" />
                                </div>
                            </div>
                            <h1 className="text-2xl font-bold text-center mb-2">Sistem Ujian Aman</h1>
                            <p className="text-center text-gray-500 mb-6">Mode Ketat (Strict Mode)</p>
                            
                            <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-sm text-yellow-800">
                                <h3 className="font-bold mb-2 flex items-center"><IconAlertTriangle className="w-4 h-4 mr-2"/> Syarat Wajib:</h3>
                                <ul className="list-disc pl-4 space-y-1">
                                    <li><b>Wajib Fullscreen.</b> Ujian tidak akan dimulai tanpa fullscreen.</li>
                                    <li>Dilarang pindah tab atau membuka aplikasi lain.</li>
                                    <li><b>Dilarang klik di luar area ujian</b> (Browser bar/Desktop).</li>
                                    <li>Maksimal 3x pelanggaran = Diskualifikasi.</li>
                                </ul>
                            </div>

                            <button 
                                onClick={startExam}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-md cursor-pointer"
                            >
                                <IconMaximize className="w-5 h-5" />
                                Mulai Ujian (Wajib Fullscreen)
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Render: Locked ---
            if (status === 'locked') {
                return (
                    <div className="min-h-screen bg-red-50 flex items-center justify-center p-4 font-sans">
                        <div className="max-w-md w-full bg-white rounded-xl shadow-xl p-8 border-t-8 border-red-600 text-center">
                            <div className="flex justify-center mb-6">
                                <IconBan className="w-16 h-16 text-red-600" />
                            </div>
                            <h2 className="text-3xl font-bold text-red-700 mb-2">UJIAN TERKUNCI</h2>
                            <p className="text-gray-600 mb-6">
                                Terdeteksi kecurangan berulang kali. Sesi didiskualifikasi.
                            </p>
                            
                            <div className="bg-gray-100 p-4 rounded-lg text-left text-sm mb-6 max-h-40 overflow-y-auto">
                                <p className="font-bold text-gray-700 mb-2">Log Pelanggaran:</p>
                                <ul className="list-disc pl-4 text-red-600">
                                    {violationLog.map((log, idx) => (
                                        <li key={idx}>{log}</li>
                                    ))}
                                </ul>
                            </div>

                            <button 
                                onClick={() => window.location.reload()}
                                className="text-gray-500 hover:text-gray-700 underline text-sm cursor-pointer"
                            >
                                Kembali ke Beranda (Reset)
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Render: Finished ---
            if (status === 'finished') {
                return (
                    <div className="min-h-screen bg-green-50 flex items-center justify-center p-4 font-sans">
                        <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 text-center">
                            <div className="flex justify-center mb-6">
                                <IconCheckCircle className="w-16 h-16 text-green-500" />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Ujian Selesai!</h2>
                            <p className="text-gray-600 mb-6">Jawaban Anda telah berhasil dikirim.</p>
                            
                            <div className="bg-green-100 p-6 rounded-xl mb-6">
                                <span className="text-sm text-green-600 uppercase font-bold tracking-wider">Nilai Akhir</span>
                                <div className="text-5xl font-extrabold text-green-700 mt-2">{score}</div>
                            </div>
                            
                            <div className="flex justify-between text-sm text-gray-500 px-4 mb-6">
                                <span>Pelanggaran: <span className="text-red-500 font-bold">{warnings}</span></span>
                                <span>Status: <span className="text-green-600 font-bold">Valid</span></span>
                            </div>

                            <button 
                                onClick={() => window.location.reload()}
                                className="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 cursor-pointer"
                            >
                                <IconRefreshCw className="w-4 h-4"/>
                                Ujian Ulang
                            </button>
                        </div>
                    </div>
                );
            }

            // --- Render: Active Exam ---
            const q = QUESTIONS[currentQuestion];
            const isLastQuestion = currentQuestion === QUESTIONS.length - 1;

            return (
                <div className="min-h-screen bg-gray-100 font-sans flex flex-col select-none relative">
                    
                    {/* --- FULLSCREEN ENFORCER OVERLAY --- */}
                    {!isFullscreen && (
                        <div className="absolute inset-0 z-50 bg-gray-900/95 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white p-8 rounded-xl max-w-md w-full text-center shadow-2xl">
                                <IconLock className="w-16 h-16 text-red-600 mx-auto mb-4" />
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Layar Penuh Diperlukan</h2>
                                <p className="text-gray-600 mb-6">
                                    Anda keluar dari mode layar penuh. Untuk melanjutkan ujian, Anda wajib kembali ke mode layar penuh.
                                </p>
                                <button 
                                    onClick={resumeExam}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 cursor-pointer shadow-lg animate-bounce"
                                >
                                    <IconMaximize className="w-5 h-5" />
                                    Kembali ke Fullscreen
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Header Bar */}
                    <div className="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                        <div className="flex items-center gap-4">
                             <div className="flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-lg font-bold">
                                    <IconClock className="w-5 h-5" />
                                    {formatTime(timeLeft)}
                             </div>
                             <div className={`flex items-center gap-2 px-3 py-1 rounded-lg font-bold ${warnings > 0 ? 'bg-red-100 text-red-600' : 'bg-green-50 text-green-600'}`}>
                                    <IconFileWarning className="w-5 h-5" />
                                    {warnings}/{MAX_WARNINGS} Peringatan
                             </div>
                        </div>
                        <div className="text-sm font-semibold text-gray-500">
                            Soal {currentQuestion + 1} dari {QUESTIONS.length}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col items-center justify-center p-4 sm:p-8">
                        <div className="max-w-3xl w-full bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                            
                            {/* Question Area */}
                            <div className="p-8 border-b border-gray-100">
                                <h2 className="text-xl sm:text-2xl font-semibold text-gray-800 leading-relaxed">
                                    {q.question}
                                </h2>
                            </div>

                            {/* Options Area */}
                            <div className="p-8 bg-gray-50">
                                <div className="space-y-3">
                                    {q.options.map((opt, idx) => {
                                        const isSelected = answers[q.id] === opt;
                                        return (
                                            <button
                                                key={idx}
                                                // PERBAIKAN: Pass q.id ke handleAnswer agar sinkron dengan state
                                                onClick={() => handleAnswer(q.id, opt)}
                                                className={`w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center justify-between group cursor-pointer
                                                    ${isSelected 
                                                        ? 'border-blue-500 bg-blue-50 text-blue-700 shadow-sm' 
                                                        : 'border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50 text-gray-700'
                                                    }`}
                                            >
                                                <span className="font-medium">{opt}</span>
                                                {isSelected && <IconCheckCircle className="w-5 h-5 text-blue-500" />}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>

                            {/* Navigation Area */}
                            <div className="p-6 bg-white border-t border-gray-200 flex justify-between">
                                <button
                                    onClick={prevQuestion}
                                    disabled={currentQuestion === 0}
                                    className={`px-6 py-2 rounded-lg font-medium transition-colors cursor-pointer ${
                                        currentQuestion === 0 
                                            ? 'text-gray-300 cursor-not-allowed' 
                                            : 'text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    Sebelumnya
                                </button>
                                
                                {isLastQuestion ? (
                                    <button
                                        onClick={finishExam}
                                        className="px-8 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-sm transition-colors cursor-pointer"
                                    >
                                        Selesai & Kirim
                                    </button>
                                ) : (
                                    <button
                                        onClick={nextQuestion}
                                        className="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-sm transition-colors cursor-pointer"
                                    >
                                        Selanjutnya
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Overlay Peringatan Pelanggaran */}
                    {warnings > 0 && warnings < MAX_WARNINGS && isFullscreen && (
                        <div className="fixed bottom-4 left-4 right-4 bg-red-600 text-white p-3 rounded-lg shadow-lg text-center text-sm animate-pulse z-40">
                            ⚠️ Terdeteksi aktivitas mencurigakan! ({warnings}/{MAX_WARNINGS})
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>